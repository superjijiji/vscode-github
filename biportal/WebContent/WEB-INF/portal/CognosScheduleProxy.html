<!DOCTYPE html SYSTEM "http://www.ibm.com/data/dtd/v11/ibmxhtml1-transitional.dtd">
<html lang="en-US" xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Cognos Schedule Panel</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="dc.rights" content="copyright (c) 2011 by IBM corporation" />
<meta name="dc.date" content="2011-12-13" />
<meta name="dc.language" content="en-US" />
<meta name="description" content="BI@IBM" />
<meta name="ibm.country" content="US" />
<meta name="keywords" content="Cognos Schedule panel" />
<meta name="owner" content="edgeteam@us.ibm.com" />
<meta name="robots" content="noindex,nofollow" />
<meta name="security" content="IBM internal use only" />
</head>
<script type="text/javascript">
	/**
	we need to setup different values for cognos_ver, cookie_domain and cookie path according to different cognos environment
	please contact with BI@IBM team if you do not know what value you need to set
	*/
	var cognos_ver = 11;
	var cookie_domain = '.b03zvi11200050.ahe.boulder.ibm.com';
	//var cookie_domain = '.inmbzp5215.in.dst.ibm.com';
	var cookie_path = '/ServletGateway/';

	if (cognos_ver == 11) {
		cookie_path = '/transform/cognitive/bi';
	}

	var logonWindow = null;
	var promptWindow = null;
	var initial_httpRequest = true;
	var ifDoLogon = false;
	var promptIDValue = '';
	var rds_url = '';
	var cognoscallbackproxy_url = '';
	//get parameter value from url
	function getUrlParam(name) {
		if (window.location.search == '' || window.location.search == undefined
				|| window.location.search == null) {
			return '';
		}
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
		var r = window.location.search.substring(1).match(reg);
		if (r != undefined && r != '' && r != null)
			return unescape(r[2]);
		return '';
	}

	function replaceAll(str, orginal, newword) {
		if (str != null) {
			str = str.replace(/orginal/g, newword)
			return str;
		}
		return '';
	}

	function setCookie(name, value, domain, path) {
		document.cookie = name + '=' + value + '; domain='+domain+'; path=' + path;
	}

	var objXHR = null;
	var objXHR2 = null;
	try {
		objXHR = new XMLHttpRequest();
		objXHR2 = new XMLHttpRequest();
	} catch (e) {
		try {
			objXHR = new ActiveXObject('Msxml2.XMLHTTP');
			objXHR2 = new ActiveXObject('Msxml2.XMLHTTP');
		} catch (e) {
			try {
				objXHR = new ActiveXObject('Microsoft.XMLHTTP');
				objXHR2 = new ActiveXObject('Microsoft.XMLHTTP');
			} catch (e) {
				initial_httpRequest = false;
				alert('Error! We are sorry, your browser does not support XMLHttpRequest\n'
						+ e);
			}
		}
	}

	function doLogon() {
		ifDoLogon = true;
		var logon_url = rds_url + '?b_action=xts.run&m=portal/close.xts&h_CAM_action=logonAs';
		logonWindow = window.open(logon_url, "logonWindow",
				"status=1, toolbar=0, menubar=0, height=" + screen.availHeight
						+ ", width=" + screen.availWidth + ", resizable=1");
	}

	function getPromptValues() {
		//get all the paramters from url
		var ifError = false;
		var errorMsg = '';
		var parameter_session = getUrlParam('parameter_session');
		if (parameter_session == '') {
			ifError = true;
			errorMsg = 'Invalid session';
		}
		var cwa_id = getUrlParam('parameter_cwa_id');
		if (cwa_id == '') {
			ifError = true;
			errorMsg = 'Invalid user id';
		}
		var report_id = getUrlParam("parameter_report_id");
		if (report_id == '') {
			ifError = true;
			errorMsg = 'Invalid report id';
		}
		rds_url = decodeURI(getUrlParam("parameter_rds_url"));
		if (rds_url == '') {
			ifError = true;
			errorMsg = 'Invalid gateway url';
		}
		cognoscallbackproxy_url = decodeURI(getUrlParam("cognoscallbackproxy_url"));
		if (cognoscallbackproxy_url == '') {
			ifError = true;
			errorMsg = 'Invalid callback server url';
		}
		var parameter_prompt_page_url = decodeURI(getUrlParam("parameter_prompt_page_url"));
		if (parameter_prompt_page_url == '') {
			ifError = true;
			errorMsg = 'Invalid prompt page url';
		}
		var parameter_prompt_page_url_m = getUrlParam("m");
		var parameter_prompt_page_url_ui_object = getUrlParam("ui.object");
		var parameter_prompt_page_url_promptID = getUrlParam("promptID");
		var parameter_prompt_page_url_routingServerGroup = getUrlParam("ui.routingServerGroup");
		//
		parameter_prompt_page_url += "&m=" + parameter_prompt_page_url_m;
		parameter_prompt_page_url += "&ui.object=" + parameter_prompt_page_url_ui_object;
		parameter_prompt_page_url += "&promptID=" + parameter_prompt_page_url_promptID;
		if (parameter_prompt_page_url_routingServerGroup != '') {
			parameter_prompt_page_url += "&ui.routingServerGroup=" + parameter_prompt_page_url_routingServerGroup;
		}

		cam_passport = decodeURI(getUrlParam("cam_passport"));
		usersessionid = decodeURI(getUrlParam("usersessionid"));
		cea_ssa = decodeURI(getUrlParam("cea_ssa"));
		CRN = decodeURI(getUrlParam("CRN"));
		userCapabilities = decodeURI(getUrlParam("userCapabilities"));
		domain_key = getUrlParam("domain_key");
		//
		if (cam_passport != '') {
			cam_passport = replaceAll(cam_passport, "my_special_and", "&");
			cam_passport = replaceAll(cam_passport, "my_special_equal", "=");
		}
		if (usersessionid != '') {
			usersessionid = replaceAll(usersessionid, "my_special_and", "&");
			usersessionid = replaceAll(usersessionid, "my_special_equal", "=");
		}
		if (cea_ssa != '') {
			cea_ssa = replaceAll(cea_ssa, "my_special_and", "&");
			cea_ssa = replaceAll(cea_ssa, "my_special_equal", "=");
		}
		if (CRN != '') {
			CRN = replaceAll(CRN, "my_special_and", "&");
			CRN = replaceAll(CRN, "my_special_equal", "=");
		}
		if (userCapabilities != '') {
			userCapabilities = replaceAll(userCapabilities, "my_special_and","&");
			userCapabilities = replaceAll(userCapabilities, "my_special_equal","=");
		}
		//
		promptIDValue = parameter_prompt_page_url_promptID;
		var parameter_promptID = parameter_prompt_page_url_promptID;

		if (ifError) {
			alert(errorMsg);
			return;
		}
		
		setCookie('cam_passport', cam_passport, cookie_domain, cookie_path);
		setCookie('CRN', CRN, cookie_domain,cookie_path);
		setCookie('cea-ssa', cea_ssa, cookie_domain,cookie_path);
		setCookie('usersessionid', usersessionid, cookie_domain,cookie_path);
		setCookie('userCapabilities', userCapabilities, cookie_domain,cookie_path);
		
		var timestamp = new Date().getTime();
		var params = "status=1, toolbar=0, menubar=0, top=0, left=0, width=" + screen.availWidth + ", height=" + screen.availHeight + ", resizable=1, scrollbars=1";
		//add follow code for Cognos RDS https bug
		if (rds_url.indexOf("https:") > -1) {
			parameter_prompt_page_url = parameter_prompt_page_url.replace(/http:/, "https:");
			parameter_prompt_page_url = parameter_prompt_page_url.replace(/:80/, ":443");
		}
		promptWindow = window.open(parameter_prompt_page_url + '&timeid=' + timestamp, "promptWindow", params);

		checkPromptClosed();

	}

	function getPromptValuesCallBack() {
		if (objXHR.readyState == 4) {
			if (objXHR.status == 200) {

				var myPromptID = objXHR.responseXML.getElementsByTagName("rds:promptID")[0].firstChild.nodeValue;
				var myURL = objXHR.responseXML.getElementsByTagName("rds:url")[0].firstChild.nodeValue;
				//add follow code for Cognos RDS https bug
				if (rds_url.indexOf("https:") > -1) {
					myURL = myURL.replace(/http:/, "https:");
				}
				var timestamp = new Date().getTime();
				if (myURL.indexOf("?") > -1) {
					myURL = myURL + '&timeid=' + timestamp;
				} else {
					myURL = myURL + '?timeid=' + timestamp;
				}
				promptIDValue = myPromptID;
				var params = "status=1, toolbar=0, menubar=0, top=0, left=0, width=" + screen.availWidth + ", height=" + screen.availHeight + ", resizable=1, scrollbars=1";
				promptWindow = window.open(myURL, "promptWindow", params);
				checkPromptClosed();
			} else if (objXHR.status == 403) {

				if (!ifDoLogon) {
					doLogon();
					checkLoginClosed();
				} else {

				}
			} else {
				alert("HTTP ERROR " + objXHR.status + ": " + objXHR.statusText);
				window.status = "Done";
			}
		}
	}

	function checkLoginClosed() {
		if (logonWindow != null && !logonWindow.closed) {
			setTimeout('checkLoginClosed()', 1000);
		} else {
			//getPromptValues();
		}
	}

	function getPromptAnswers() {
		var timestamp = new Date().getTime();
		var myPromptAnswers = rds_url + "/rds/promptAnswers/conversationID/" + promptIDValue + "?timeid=" + timestamp;
		try {
			objXHR2.open("GET", myPromptAnswers, true);

			objXHR2.onreadystatechange = getPromptAnswersCallBack;
			objXHR2.send(null);
		} catch (e) {
			alert(e);
		}
	}

	function checkPromptClosed() {
		if (!promptWindow.closed) {
			setTimeout('checkPromptClosed()', 1000);
		} else {
			getPromptAnswers();
		}
	}

	function XMLtoString(elem) {
		var serialized;
		try {
			// XMLSerializer exists in current Mozilla browsers
			serializer = new XMLSerializer();
			serialized = serializer.serializeToString(elem);
		} catch (e) {
			// Internet Explorer has a different approach to serializing XML
			serialized = elem.xml;
		}
		return serialized;
	}

	function getPromptAnswersCallBack() {
		if (objXHR2.readyState == 4) {
			if (objXHR2.status == 200) {
				iframe = document.getElementById("id_frame_pickup_prompts");
				if (iframe == null) {
					iframe = document.createElement('iframe');
					iframe.id = "id_frame_pickup_prompts";
					iframe.src = "about:blank";
					iframe.frameborder = "0";
					iframe.style.width = "0px";
					iframe.style.height = "0px";
					iframe.style.display = 'none';
					iframe.title = 'get_prompts';
					document.body.appendChild(iframe);
					iframe.contentWindow.document.open();
					response_xml = XMLtoString(objXHR2.responseXML).replace(/&/g, '%26');
					iframe.contentWindow.document.write("<html><head></head><body><form id='id_form_postData' method='post' target='_self'><input name='responseText' id='id_form_input_responseText' type='text' value='" + encodeURI(response_xml).replace(/\'/g,'%27') + "'/></form></body></html>");
					iframe.contentWindow.document.close();
				}
				iframe.contentWindow.document.getElementById("id_form_postData").action = cognoscallbackproxy_url;
				iframe.contentWindow.document.getElementById("id_form_postData").submit();
			} else {
				alert("HTTP ERROR " + objXHR2.status + ": " + objXHR2.statusText);
				window.status = "Done";
			}

		}
	}
</script>
<body onload="getPromptValues()" role="application">
	<div class="skip">
		<a accesskey="2" href="#content-main">BI@IBM Cognos Schedule proxy</a>
	</div>
	<div id="content-main"></div>
</body>
</html>

